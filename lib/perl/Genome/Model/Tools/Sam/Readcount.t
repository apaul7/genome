#!/usr/bin/env genome-perl

use strict;
use warnings FATAL => 'all';

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above "Genome";
use Test::Exception;
use Test::More;
use Genome::Utility::Test qw(compare_ok);

my $pkg = 'Genome::Model::Tools::Sam::Readcount';
use_ok($pkg) or die;
my $test_data_dir = Genome::Utility::Test->data_dir_ok($pkg, '1');

my $output = Genome::Sys->create_temp_file_path;
my $expected = File::Spec->join($test_data_dir, 'expected');

my $reference = Genome::Model::Build::ImportedReferenceSequence->get_by_name('NCBI-human-build36');

my $cmd = $pkg->create(
    output_file => $output,
    bam_file => File::Spec->join($test_data_dir, 'tiny.bam'),
    region_list => File::Spec->join($test_data_dir, 'regions'),
    reference_fasta => $reference->full_consensus_path('fa'),
);

subtest 'testing command execution' => sub {
    ok($cmd->execute, "Executed $pkg");
    compare_ok($expected, $output, 'readcount file looks as expected');
};

subtest 'version specific options' => sub {
    plan tests => 6;

    ok(!$pkg->version_has_warning_suppression('0.4'), 'version 0.4 does not have warning_suppression');
    ok($pkg->version_has_warning_suppression('0.5'), 'version 0.5 does have warning_suppression');

    ok(!$pkg->version_has_insertion_centric('0.4'), 'version 0.4 does not have insertion_centric');
    ok($pkg->version_has_insertion_centric('0.5'), 'version 0.5 does have insertion_centric');

    throws_ok(
        sub{ $pkg->assert_version_has_insertion_centric('0.4'); },
        qr/Option insertion_centric is unsupported in version 0\.4/,
        'version 0.4 asserts it does not have insertion_centric',
    );
    ok($pkg->assert_version_has_insertion_centric('0.5'), 'version 0.5 asserts it does have insertion_centric');
};

subtest 'testing command strings' => sub {
    plan tests => 5;

    my %expected_command = (
        0.3 => qr"/usr/bin/bam-readcount0.3 $test_data_dir/tiny.bam -f .+/model_data/2741951221/build101947881/all_sequences.fa -l $test_data_dir/regions 2> /dev/null",
        0.4 => qr"/usr/bin/bam-readcount0.4 $test_data_dir/tiny.bam -f .+/model_data/2741951221/build101947881/all_sequences.fa -l $test_data_dir/regions 2> /dev/null",
        0.5 => qr"/usr/bin/bam-readcount0.5 $test_data_dir/tiny.bam -f .+/model_data/2741951221/build101947881/all_sequences.fa -l $test_data_dir/regions -w 1",
        0.6 => qr"/usr/bin/bam-readcount0.6 $test_data_dir/tiny.bam -f .+/model_data/2741951221/build101947881/all_sequences.fa -l $test_data_dir/regions -w 1",
    );

    for my $version (keys %expected_command) {
        $cmd->use_version($version);
        like($cmd->command, $expected_command{$version}, "The command string looks as expected for version $version");
    }

    $cmd->use_version('0.4');
    $cmd->insertion_centric(1);
    dies_ok(sub{ $cmd->command; }, "The command string builder dies for version 0.4 and insertion_centric");

};

done_testing();

